<html>
	<script src="/socket.io/socket.io.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/jquery-ui.min.js"></script>
	<script type="text/javascript" src="./jquery-simple-datetimepicker/jquery.simple-dtpicker.js"></script>
	<link type="text/css" href="./jquery-simple-datetimepicker/jquery.simple-dtpicker.css" rel="stylesheet" />
	<link type="text/css" href="./strike4/jquery-ui-1.9.2.custom.min.css" rel="stylesheet" />
	<link type="text/css" href="./strike4/additions.css" rel="stylesheet" />
	<script>
		var socket = io.connect('http://phoenix.mpe.lv');
		socket.on('handshake', function (data) {
			console.log(data.welcome);
			$('#info').info('update', data.welcome);
		});
		//query finished
		socket.on('count', function (count) {
			console.log('Found ' + count);
			$('#info').info('update', 'Found ' + count);
			setTimeout(function () {
				$('#tabs').tabs('refresh');
			}, 500);
		});
		//display server time
		socket.on('clock', function (time) {
			$('#clock').text(time);
		});
		//query
		socket.on('query-waypoint', function (data) {
			console.info(data);
			if(undefined != data) 
				showWaypoint(data, 'query-table');
		});
		//got new live waypoint
		socket.on('update-waypoint', function (data) {
			console.info(data);
			if(undefined != data)  {
				var message = document.createElement('div');
				message.classList.add('q-row');
				//time
				var time = document.createElement('span');
				var g_time = new Date(data.gps_timestamp);
				time.textContent = g_time.getHours() + ':' + g_time.getMinutes();;
				time.classList.add('q-time-now');
				message.appendChild(time);
				//speed
				var kphArr = data.kph.split('.');
				var speed = document.createElement('span');
				speed.classList.add('q-speed-now');
				var integer = document.createElement('span');
				integer.style.fontSize = '1.2em';
				integer.textContent = kphArr[0];
				var fraction = document.createElement('span');
				fraction.style.fontSize = '0.6em';
				fraction.textContent = kphArr[1];
				speed.appendChild(integer);
				speed.appendChild(fraction);
				message.appendChild(speed);
				//address
				var address = document.createElement('span');
				address.textContent = data.address;
				address.classList.add('q-address-now');
				message.appendChild(address);
				//display message in info box
				$('#info').info('update', message.outerHTML, 'update');
				//show new way point in table
				showWaypoint(data, 'updates-table');
				$('#tabs').tabs('refresh');
			}
		});
		//got tracked modules list
		socket.on('tracklist', function (list) {
				renderList(list);
		});
		function query() {
			flushTable('query-table');
			var re = /(\d+):(\d+)\ (\d+)\.(\d+)\.(\d+)/;//m:H D.M.YYYYY
			var timeoffset = (new Date).getTimezoneOffset() / 60
			var strStartDate = document.querySelector('#start-date').value;
			var arStartDate = re.exec(strStartDate);
			var strEndDate = document.querySelector('#end-date').value;
			var arEndDate = re.exec(strEndDate);
			var startDate = new Date(Date.UTC(arStartDate[5], --arStartDate[4],
				arStartDate[3],  timeoffset + parseInt(arStartDate[1]), arStartDate[2]));
			var endDate = new Date(Date.UTC(arEndDate[5], --arEndDate[4],
				arEndDate[3], timeoffset + parseInt(arEndDate[1]), arEndDate[2]));
			console.info('Query  %s ... %s', startDate, endDate);
			socket.emit('query', {start: startDate.valueOf(), end: endDate.valueOf()});
		}
		//render way point in corresponding table
		function showWaypoint(message, tableName) {
			var table = document.getElementById(tableName);
			var row = document.createElement('tr');
			row.id = message.gps_timestamp;
			
			var time = row.insertCell(-1);
			var g_time = new Date(parseInt(message.gps_timestamp));
			if(tableName == 'updates-table') {
				if(table.childNodes.length > 10) { //limit to last 10 updates
					table.removeChild(table.firstChild);
				}
				time.textContent = g_time.getHours() + ':' + g_time.getMinutes();
			} else {
				time.innerHTML = g_time.getDate() + '.' + (g_time.getMonth()+1) + '.' + g_time.getFullYear()
					+ ' <b>' + g_time.getHours() + ':' + g_time.getMinutes() + '</b>';
			}
			time.classList.add('q-time');
			
			var address = row.insertCell(-1);
			address.textContent = message.address;
			address.classList.add('q-address');
			
			var speed = row.insertCell(-1);
			speed.textContent = message.kph + ' km/h';
			speed.classList.add('q-speed');
			
			table.appendChild(row);
		}
		function flushTable(tableName) {
			var table = document.getElementById(tableName);
			while (table.lastChild) {
				table.removeChild(table.lastChild);
			}
		}
		function updateList() {
			var table = document.getElementById('trackedlist-table');
			var changes = {
				add: new Array,
				remove: new Array
			}
			var id;
			for(var i = 0; i < table.childNodes.length; i++) {
				node = table.childNodes[i];
				id = node.querySelector('input').value;
				if ('' == id) continue;
				if('hidden' == node.style.visibility) {
					changes.remove.push(id);
				} else {
					changes.add.push(id);
				}
			}
			console.info('add:',changes.add, 'remove', changes.remove);
			socket.emit('update-tracklist', changes);
			getList();
		}
		function getList() {
			socket.emit('get-tracklist');
		}
		function renderList(list) {
			flushTable('trackedlist-table');
			var item;
			while (item = list.pop()) {
				appendList(item);
			}
		};
		function appendList(item) {
			var table = document.getElementById('trackedlist-table');
			var row = document.createElement('tr');
			var cell = row.insertCell(-1);
			//text field
			var input = document.createElement('input');
			input.value = (typeof(item) == 'object' ? '' : item);
			//remove button
			var button = document.createElement('input');
			button.type = 'button'; button.value = '-';
			//assemble
			cell.appendChild(input);
			cell.appendChild(button);
			table.appendChild(row);
			$(function () {
				$('td > input[type=\'button\']').button().click(removeRow);
			});
		}
		function removeRow() {
			var row = this.parentNode.parentNode;
			row.style.visibility = 'hidden';
		}
		(function( $ ) {
			var methods = {
				init: function( options ) {
					var $this = this;
					return this.each(function () {
						$this.settings = $.extend( {
							'timeout': 10
						}, options);
						$this.attr('timeout', $this.settings.timeout * 1000);
						$this.addClass('info');
					})
				},
				show: function() {},
				hide: function() {},
				update: function( message, type, time ) {
					var $this = this;
					return this.each(function () {
						if($this.hasClass('ui-state-error')) {
							$this.removeClass('ui-state-error');
						}
						if(type == 'update') {
							window.clearTimeout(window.infoTimer);
							window.infoTimer = setTimeout(function () {
								$this.addClass('ui-state-error');
							}, $this.attr('timeout'))
						}
						$this.effect('highlight');
						$this.html(message);
					});
				}
			}
			$.fn.info = function( method ) {		
				if ( methods[ method ] ) {
					return methods[ method ].apply( this, Array.prototype.slice.call( arguments, 1 ));
				} else if ( typeof method === 'object' || ! method ) {
					return methods.init.apply( this, arguments );
				} else {
					$.error( 'Method ' +  method + ' does not exist on jQuery.info' );
				}
			}
		}) ( jQuery );
	</script>
	<body>
		<table class='q-table'>
			<tr>
				<td><div id='info'></div></td>
				<td style='width: 5em'><div id='clock'></div></td>
			</tr>
		</table>
		<div id='tabs'>
			<ul>
				<li><a href='#tabs-updates'>Now</a></li>
				<li><a href='#tabs-query'>Query</a></li>
				<li><a href='#tabs-settings'>Settings</a></li>
			</ul>
			<div id='tabs-query'>
				<input type="text" id="start-date">
				<input type="text" id="end-date">
				<input type='button' id='query' value='Query'>
				<table id='query-table' class='q-table'></table>
			</div>
			<div id='tabs-updates'>
				<table id='updates-table' class='u-table'></table>
			</div>
			<div id='tabs-settings'>
				<table id='trackedlist-table'></table>
				<input type='button' id='update-list' value='Update'>
				<input type='button' id='append-list' value='+'>
			</div>
		</div>
		<script type="text/javascript">
			$(function(){
				var date = new Date;
				var yesterDate = date.getFullYear() + '-'
					+ (date.getMonth()+1) + '-' + (date.getDate()-1)
					+ ' ' + date.getHours() + ':' + date.getMinutes();
				//console.log(currentDate)
				$('#start-date').appendDtpicker({
					dateFormat: 'h:mm D.M.YYYY',
					current: yesterDate
				})
				$('#end-date').appendDtpicker({
					dateFormat: 'h:mm D.M.YYYY'
				})
			});
			$(function () {
				$('#query').button().click(query);
			});
			$(function () {
				$('#update-list').button().click(updateList);
			});
			$(function () {
				$('#append-list').button().click(appendList);
			});
			$(function() {
				$('#tabs').tabs({
					activate: function(event, ui) {
						if('#tabs-settings' == ui.newTab.context.hash) {
							getList();
						}
					}
				});
			});
			$(function () {
				$('#info').info({'timeout': 300});
			});
		</script>
	</body>
</html>

